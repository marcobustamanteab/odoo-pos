version: '3'
services:
  {{ odoo.service_name }}:
    image: odoo-pos
    container_name: {{ odoo.container_name }}

    user: root
    ports:
      - 8069:8069
      {%- if odoo.debug %}
      - 8888:3001
      {%- endif %}
    build:
      context: .
      dockerfile: Dockerfile
      {%- if odoo.mode == 'update' %}
      command: -u ${MODULE} -d MASTER --test-enable --stop-after-init
      {%- elif odoo.mode == 'install' %}
      command: -i ${MODULE} -d MASTER --test-enable --stop-after-init
      {%- endif %} 
    networks:
      - frontend
      - backend

    {% if odoo.debug -%}
    entrypoint: ['/entrypoint.sh', 'odoo', 'dev']
    {%- else -%}
    entrypoint: ['/entrypoint.sh', 'odoo']
    {%- endif %}      
    volumes:
      - ./config:/etc/odoo
      - ./enterprise:/mnt/enterprise
      - ./src/custom-addons:/mnt/extra-addons/custom-addons

  {{ nginx.service_name }}:     
    container_name: {{ nginx.container_name }}
    restart: unless-stopped
    image: nginx:latest
    networks:
      - frontend
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./nginx/nginx-config/nginx_template.conf:{{ nginx.path_config }}
      - ./nginx/ssl/private.key:{{ nginx.path_ssl_certificate_key }}
      - ./nginx/ssl/public.cer:{{ nginx.path_ssl_certificate }}

networks:
  frontend:
      name: frontend

  backend:
    external:
      name: backend
