version: '3'
services:
  {{ odoo.service_name }}:
  {%- if env == 'DEV' or env == 'QA' or env == 'PROD' %}  
    image: registry.ccu.cl/odoo:ccu_pos-$SHA
  {%- else %}
    build: .
  {%- endif %}    
    container_name: {{ odoo.container_name }}
    user: root
    ports:
      - 8070:8069
      {%- if debug %}
      - 8888:3001
      {%- endif %}
    networks:
      - odoo-pos
      - proxy
    entrypoint: ['/entrypoint.sh', 'odoo', '-d', '{{ database.POSTGRES_DB }}', '-i', 'base']
    volumes:
      - ../filestore:{{ odoo.data_dir }}
      - ./logs:/var/log/odoo
    {%- if env != 'DEV' and env != 'QA' and env != 'PROD' %}
      - ./config:/etc/odoo
      - ./src/custom-addons:/mnt/extra-addons/custom-addons
    {%- endif %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.{{ odoo.service_name }}.entrypoints=websecure"
      - "traefik.http.routers.{{ odoo.service_name }}.service={{ odoo.service_name }}"
      - "traefik.http.services.{{ odoo.service_name }}.loadbalancer.server.port=8069"
      - "traefik.http.routers.{{ odoo.service_name }}.rule=Host(`pos.ccu.cl`)"                  

  # {%- if env == 'DEV' or env == 'QA' or env == 'PROD' %}     
  # {{ nginx.service_name }}:     
  #   container_name: {{ nginx.container_name }}
  #   restart: unless-stopped
  #   image: nginx:latest
  #   networks:
  #     - odoo-pos
  #   ports:
  #     - 80:80
  #     - 443:443
  #   volumes:
  #     - ./nginx/nginx-config/nginx_template.conf:{{ nginx.path_config }}
  #     - ./nginx/ssl/private.key:{{ nginx.path_ssl_certificate_key }}
  #     - ./nginx/ssl/public.cer:{{ nginx.path_ssl_certificate }}
  # {%- endif %}    

networks:
  odoo-pos:
    external: true   
  proxy:
    external: true      
