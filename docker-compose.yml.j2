version: '3'
services:
  {{ odoo.service_name }}:
  {%- if env == 'DEV' or env == 'QA' or env == 'PROD' %}  
    image: {{ registry }}/odoo:ccu_pos-$SHA
  {%- else %}
    build: .
  {%- endif %}    
    container_name: {{ odoo.container_name }}
    user: root
    ports:
      - {{ odoo.port }}:8069
      {%- if debug %}
      - 8888:3001
      {%- endif %}
    networks:
      - odoo-pos
    entrypoint: ['/entrypoint.sh', 'odoo']
    volumes:
      - ../filestore:{{ odoo.data_dir }}
      - ./logs:/var/log/odoo
      - /lv_truck:/lv_truck
    {%- if env != 'DEV' and env != 'QA' and env != 'PROD' %}
      - ./config:/etc/odoo
      - ./src/custom-addons:/mnt/extra-addons/custom-addons
    {%- endif %}

  {%- if env == 'DEV' or env == 'QA' or env == 'PROD' %}     
  {{ nginx.service_name }}:     
    container_name: {{ nginx.container_name }}
    restart: unless-stopped
    image: nginx:latest
    networks:
      - odoo-pos
      - proxy
    ports:
      - {{ nginx.port }}:80
    volumes:
      - ./nginx/nginx-config/nginx_template.conf:{{ nginx.path_config }}
      - ./nginx/ssl/private.key:{{ nginx.path_ssl_certificate_key }}
      - ./nginx/ssl/public.cer:{{ nginx.path_ssl_certificate }}
  {%- endif %}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.{{ nginx.service_name }}.entrypoints=websecure"
      - "traefik.http.routers.{{ nginx.service_name }}.service={{ nginx.service_name }}"
      - "traefik.http.services.{{ nginx.service_name }}.loadbalancer.server.port=80"    
      - "traefik.http.routers.{{ nginx.service_name }}.rule=Host(`{{ nginx.domain_name }}`)"
      - "traefik.http.middlewares.securityHeaders.headers.framedeny=true"
      - "traefik.http.middlewares.securityHeaders.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.securityHeaders.headers.referrerPolicy=no-referrer"
      - "traefik.http.middlewares.securityHeaders.headers.permissionsPolicy=accelerometer=(none), ambient-light-sensor=(none), autoplay=(none), battery=(none), camera=(none), cross-origin-isolated=(self), display-capture=(self), document-domain=(self), encrypted-media=(self), execution-while-not-rendered=(self), execution-while-out-of-viewport=(self), fullscreen=(self), geolocation=(self), gyroscope=(none), keyboard-map=(none), magnetometer=(none), microphone=(none), midi=(none), navigation-override=(self), payment=(none), picture-in-picture=(self), publickey-credentials-get=(none), screen-wake-lock=(none), sync-xhr=(self), usb=(none), web-share=(none), xr-spatial-tracking=(none)"
      - "traefik.http.middlewares.securityHeaders.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.securityHeaders.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.securityHeaders.headers.contentSecurityPolicy=default-src https://odooventas-qa.ccu.cl https://fonts.odoocdn.com https://fonts.googleapis.com https://fonts.gstatic.com"
      - "traefik.http.middlewares.securityHeaders.headers.customresponseheaders.Cross-Origin-Embedder-Policy=require-corp"
      - "traefik.http.middlewares.securityHeaders.headers.customresponseheaders.Cross-Origin-Resource-Policy=same-origin"
      - "traefik.http.middlewares.securityHeaders.headers.customresponseheaders.Cross-Origin-Opener-Policy=same-origin"
      - "traefik.http.middlewares.securityHeaders.headers.customresponseheaders.Server="
      - "traefik.http.routers.{{ nginx.service_name }}.middlewares=securityHeaders@docker"
      - "traefik.docker.network=proxy"                       

networks:
  odoo-pos:
    external: true   
  proxy:
    external: true      
